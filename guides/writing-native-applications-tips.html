<!DOCTYPE html>
<html>

<head>
  <title>Writing Native Applications Tips</title>
  <script id="adobe_dtm" src="//www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlightjs-pack.js" type="text/javascript"></script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/assets/css/main.css" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="https://quarkus.io//feed.xml" title="Quarkus">
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NJWS5L');</script>
  <!-- End Google Tag Manager -->
  <!-- Syntax highlighting -->
  <script>hljs.initHighlightingOnLoad();</script>
</head>

<body class="guides">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJWS5L"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <div class="content">
    <div class="navigation-wrapper">
  <div class="width-12-12">
    <div class="header navigation">
      <div class="logo-wrapper">
        <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
      </div>
      <div class="nav-container">
        <nav>
          <div class="nav-mobile"><a id="nav-toggle" href="#!"><span></span></a></div>
          <ul class="nav-list">
            <li>
              <a href="/get-started/" class="">Get Started</a>
            </li>
            <li>
              <a href="/guides/" class="active">Guides</a>
            </li>
            <li>
              <a href="/extensions/" class="">Extensions</a>
            </li>
            <li>
              <a href="/community/" class="">Community</a>
            </li>
            <li>
              <a href="/blog/" class="">Blog</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>

    <div class="guides">
  <div class="width-12-12">
    <h1 class="text-caps">Writing Native Applications Tips</h1>
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This guide contains various tips and tricks for getting around problems that might arise when attempting to run java applications as native executables.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="register-reflection">Register reflection</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Due to the fact that when building a native executable GraalVM operates with a closed world assumption (which enables it to remove all unused code, which in turns yields multiple benefits), reflection targets need to be explicitly declared.</p>
</div>
<div class="paragraph">
<p>An example of failing to explicitly specify reflection is the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Caused by: org.xml.sax.SAXException: SAX2 driver class com.sun.org.apache.xerces.internal.parsers.SAXParser not found
java.lang.ClassNotFoundException: com.sun.org.apache.xerces.internal.parsers.SAXParser
at org.xml.sax.helpers.XMLReaderFactory.loadClass(XMLReaderFactory.java:230)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If one were to execute the native executable generation process manually, the <code>-H:ReflectionConfigurationFiles=</code> flag would be used to point to a JSON configuration file that specifies the program elements that would be accessed reflectively.</p>
</div>
<div class="paragraph">
<p>Quarkus however makes registration of reflection a breeze by using the <code>ReflectiveClassBuildItem</code>, thus eliminating the need for such a JSON configuration file.</p>
</div>
<div class="paragraph">
<p>To solve the problem shown in the example above one would need to create a Quarkus processor class and add a build step that registers reflection.
A simple example could like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class SaxParserProcessor {

    @BuildStep
    ReflectiveClassBuildItem reflection() {
        // since we only need reflection to the constructor of the class, we can specify `false` for both the methods and the fields arguments.
        return new ReflectiveClassBuildItem(false, false, "com.sun.org.apache.xerces.internal.parsers.SAXParser");
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>More information about reflection in GraalVM can be found <a href="https://github.com/oracle/graal/blob/master/substratevm/REFLECTION.md">here</a>.</p>
</div>
<div class="sect2">
<h3 id="alternative-with-registerforreflection">Alternative with @RegisterForReflection</h3>
<div class="paragraph">
<p>In application code it is often needed to pass classes to libraries that use reflection to figure out the methods/fields of those classes.
One such example is using <a href="http://json-b.net/">JSON-B</a> like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">    public class Person {
        private String first;
        private String last;

        public String getFirst() {
            return first;
        }

        public void setFirst(String first) {
            this.first = first;
        }

        public String getLast() {
            return last;
        }

        public void setValue(String last) {
            this.last = last;
        }
    }

    @Path("/person")
    @Produces(MediaType.APPLICATION_JSON)
    @Consumes(MediaType.APPLICATION_JSON)
    public class PersonResource {

        private final Jsonb jsonb;

        public PersonResource() {
            jsonb = JsonbBuilder.create(new JsonbConfig());
        }

        @GET
        public Response list() {
            return Response.ok(jsonb.fromJson("{\"first\":  \"foo\", \"last\":  \"bar\"}", Person.class)).build();
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we were to use the code above, we would get an exception like the following when using the native executable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"> Exception handling request to /person: org.jboss.resteasy.spi.UnhandledException: javax.json.bind.JsonbException: Can't create instance of a class: class org.acme.jsonb.Person, No default constructor found</code></pre>
</div>
</div>
<div class="paragraph">
<p>An even nastier possible outcome could be for no exception to be thrown, but instead the JSON result would be completely empty.</p>
</div>
<div class="paragraph">
<p>To get around such problems, simply annotate <code>Person</code> with <code>@RegisterForReflection</code> so Quarkus will register the class as using reflection.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="including-resources">Including resources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default when building a native executable, GraalVM will not include any of the resources which are on the classpath into the native executable it creates. Such resources that are meant to be part of the native executable need to be specified explicitly.</p>
</div>
<div class="paragraph">
<p>If one were to execute the native executable generation process manually, the <code>-H:IncludeResources=</code> flag would be used to point to a JSON configuration file that specifies which resources are to be included.</p>
</div>
<div class="paragraph">
<p>Quarkus eliminates the need for such a JSON configuration file by allowing extension authors to specify a <code>SubstrateResourceBuildItem</code>.</p>
</div>
<div class="paragraph">
<p>An example use could look like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class ResourcesProcessor {

    @BuildStep
    SubstrateResourceBuildItem substrateResourceBuildItem() {
        return new SubstrateResourceBuildItem("META-INF/extra.properties");
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information about GraalVM&#8217;s resource handling in native executables please see <a href="https://github.com/oracle/graal/blob/master/substratevm/RESOURCES.md">this</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="delay-class-initialization">Delay class initialization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are cases where the initialization of certain classes is done in a static block (which means by default that GraalVM performs the initialization at image build time) needs to be postponed to runtime.
Typically omitting such configuration would result in a runtime exception like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Error: No instances are allowed in the image heap for a class that is initialized or reinitialized at image runtime: sun.security.provider.NativePRNG
Trace: object java.security.SecureRandom
method com.amazonaws.services.s3.model.CryptoConfiguration.&lt;init&gt;(CryptoMode)
Call path from entry point to com.amazonaws.services.s3.model.CryptoConfiguration.&lt;init&gt;(CryptoMode):</code></pre>
</div>
</div>
<div class="paragraph">
<p>If one were to execute the native executable generation process manually, the <code>--delay-class-initialization-to-runtime=com.amazonaws.services.s3.model.CryptoConfiguration</code> flag would need to be passed to <code>native-image</code> to configure runtime initialization for <code>CryptoConfiguration</code>.</p>
</div>
<div class="paragraph">
<p>Quarkus simplifies things by allowing extensions authors to simply register a <code>RuntimeInitializedClassBuildItem</code>. A simple example of doing so could be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class S3Processor {

    @BuildStep
    RuntimeInitializedClassBuildItem cryptoConfiguration() {
        return new RuntimeInitializedClassBuildItem(CryptoConfiguration.class.getCanonicalName());
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using such a construct means that a <code>--delay-class-initialization-to-runtime</code> option will automatically be added to the <code>native-image</code> command line</p>
</div>
<div class="paragraph">
<p>For more information about <code>--delay-class-initialization-to-runtime</code>, please read <a href="https://medium.com/graalvm/understanding-class-initialization-in-graalvm-native-image-generation-d765b7e4d6ed">this blog post</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="proxy-classes-management">Proxy Classes management</h2>
<div class="sectionbody">
<div class="paragraph">
<p>While writing native application you&#8217;ll need to define proxy classes at image build time by specifying the list of interfaces that they implement.</p>
</div>
<div class="paragraph">
<p>In such a situation the error you might encounter is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">com.oracle.svm.core.jdk.UnsupportedFeatureError: Proxy class defined by interfaces [interface org.apache.http.conn.HttpClientConnectionManager, interface org.apache.http.pool.ConnPoolControl, interface com.amazonaws.http.conn.Wrapped] not found. Generating proxy classes at runtime is not supported. Proxy classes need to be defined at image build time by specifying the list of interfaces that they implement. To define proxy classes use -H:DynamicProxyConfigurationFiles=&lt;comma-separated-config-files&gt; and -H:DynamicProxyConfigurationResources=&lt;comma-separated-config-resources&gt; options.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Quarkus allows extensions authors to register a <code>SubstrateProxyDefinitionBuildItem</code>. An example of doing so is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="java" class="language-java hljs">public class S3Processor {

    @BuildStep
    SubstrateProxyDefinitionBuildItem httpProxies() {
        return new SubstrateProxyDefinitionBuildItem("org.apache.http.conn.HttpClientConnectionManager",
                "org.apache.http.pool.ConnPoolControl", "com.amazonaws.http.conn.Wrapped");
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using such a construct means that a <code>-H:DynamicProxyConfigurationResources=&lt;comma-separated-config-resources&gt;</code> option will automatically be added to the <code>native-image</code> command line.</p>
</div>
<div class="paragraph">
<p>For more information about Proxy Classes you can read the following <a href="https://github.com/oracle/graal/blob/master/substratevm/DYNAMIC_PROXY.md">documentation</a></p>
</div>
</div>
</div>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. Quarkus and its extensions are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license.<br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a> is hosted on <a href='https://pages.github.com/' target='_blank'>Github Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what youâ€™ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>Navigation</span>
        <ul class="footer-links width-1-12">
          
            <li><a href="/">Home</a></li>
          
            <li><a href="/guides">Guides</a></li>
          
            <li><a href="/get-started">Get Started</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Contribute</span>
        <ul class="footer-links width-1-12">
          
            <li><a href="https://twitter.com/quarkusio">Follow us</a></li>
          
            <li><a href="https://github.com/quarkusio">GitHub</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Get Help</span>
        <ul class="footer-links width-1-12">
          
            <li><a href="https://quarkusio.zulipchat.com">Chatroom</a></li>
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev">Google&nbsp;Groups</a></li>
          
            <li><a href="/faq">FAQ</a></li>
          
        </ul>
      </div>
    

    
      <div class="width-6-12 more-links">
        <span>Quarkus is proudly made of</span>
        <ul class="footer-links">
          
            <li><a href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
        </ul>
      </div>
    
  </div>
</div>
  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a>
      | <a href="https://www.redhat.com/en/about/privacy-policy">Red Hat Privacy Policy</a>
    </span>
    <span class="redhat">
      a Red Hat sponsored project   
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script type="text/javascript">
    if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
        _satellite.pageBottom();
    }
  </script>
</body>

</html>
