<!DOCTYPE html>
<html>

<head>
  <script id="adobe_dtm" src="//www.redhat.com/dtm.js" type="text/javascript"></script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/assets/css/main.css" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NJWS5L');</script>
  <!-- End Google Tag Manager -->


</head>

<body class="guides">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJWS5L"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <div class="content">
    <div class="navigation-wrapper">
  <div class="width-12-12">
    <div class="header navigation">
      <div class="logo-wrapper">
        <a class="styled-logo" href="/">Quarkus</a>
      </div>
      <div class="nav-container">
        <nav>
          <div class="nav-mobile"><a id="nav-toggle" href="#!"><span></span></a></div>
          <ul class="nav-list">
            <li>
              <a href="/get-started/" class="">Get Started</a>
            </li>
            <li>
              <a href="/guides/" class="active">Guides</a>
            </li>
            <li>
              <a href="/extensions/" class="">Extensions</a>
            </li>
            <li>
              <a href="/community/" class="">Community</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>

    <div class="grid-wrapper guides">
  <div class="grid__item width-12-12">
    <h1 class="text-caps">Using Transactions in Quarkus</h1>
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus comes with a Transaction Manager and uses it to coordinate and expose transactions to your applications.
Each extension dealing with persistence will integrate with it for you.
And you will explicitly interact with transactions via CDI.
This guide will walk you through all that.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setting-it-up">Setting it up</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You don&#8217;t need to worry about setting it up most of the time as extensions needing it will simply add it as a dependency.
Hibernate ORM for example will include the transaction manager and set it up properly.</p>
</div>
<div class="paragraph">
<p>You might need to add it as a dependency explicitly if you are using transactions directly without Hibernate ORM for example.
Add the following to your <code>pom.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
    &lt;!-- Transaction Manager extension --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
        &lt;artifactId&gt;quarkus-narayana-jta-deployment&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="starting-and-stopping-transactions-defining-your-boundaries">Starting and stopping transactions: defining your boundaries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can define your transaction boundaries the easy way, or the less easy way :)</p>
</div>
<div class="sect2">
<h3 id="declarative-approach">Declarative approach</h3>
<div class="paragraph">
<p>The easiest way to define your transaction boundaries is to use the <code>@Transactional</code> annotation on your entry method (<code>javax.transaction.Transactional</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@ApplicationScoped
public class SantaClausService {

    @Inject ChildDAO childDAO;
    @Inject SantaClausDAO santaDAO;

    @Transactional <b class="conum">(1)</b>
    public void getAGiftFromSanta(Child child, String giftDescription) {
        // some transaction work
        Gift gift = childDAO.addToGiftList(child, giftDescription);
        if (gift == null) {
            throw new OMGGiftNotRecognizedException(); <b class="conum">(2)</b>
        }
        else {
            santaDAO.addToSantaTodoList(gift);
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This annotation defines your transaction boundaries and will wrap this call within a transaction.</p>
</li>
<li>
<p>A <code>RuntimeException</code> crossing the transaction boundaries will rollback the transaction.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><code>@Transactional</code> can be used to control transaction boundaries on any CDI bean at the method level or at the class level to ensure every method is transactional.
That includes REST endpoints.</p>
</div>
<div class="paragraph">
<p>You can control whether and how the transaction is started with parameters on <code>@Transactional</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@Transactional(REQUIRED)</code> (default): starts a transaction if none was started, stays with the existing one otherwise.</p>
</li>
<li>
<p><code>@Transactional(REQUIRES_NEW)</code>: starts a transaction if none was started ; if an existing one was started, suspends it and starts a new one for the boundary of that method.</p>
</li>
<li>
<p><code>@Transactional(MANDATORY)</code>: fails if no transaction was started ; works within the existing transaction otherwise.</p>
</li>
<li>
<p><code>@Transactional(SUPPORTS)</code>: if a transaction was started, joins it ; otherwise works with no transaction.</p>
</li>
<li>
<p><code>@Transactional(NOT_SUPPORTED)</code>: if a transaction was started, suspends it and works with no transaction for the boundary of the method ; otherwise works with no transaction.</p>
</li>
<li>
<p><code>@Transactional(NEVER)</code>: if a transaction was started, raises an exception ; otherwise works with no transaction.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>REQUIRED</code> or <code>NOT_SUPPORTED</code> are probably the most useful ones.
This is how you decide whether a method is to be running within or outside a transaction.
Make sure to check the JavaDoc for the precise semantic.</p>
</div>
<div class="paragraph">
<p>The transaction context is propagated to all calls nested in the <code>@Transactional</code> method as you would expect (in this example <code>childDAO.addToGiftList()</code> and <code>santaDAO.addToSantaTodoList()</code>).
The transaction will commit unless a runtime exception crosses the method boundary.
You can override whether an exception forces the rollback or not by using <code>@Transactional(dontRollbackOn=SomeException.class)</code> (or <code>rollbackOn</code>).</p>
</div>
<div class="paragraph">
<p>You can also programmatically ask for a transaction to be marked for rollback.
Inject a <code>TransactionManager</code> for this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@ApplicationScoped
public class SantaClausService {

    @Inject TransactionManager tm; <b class="conum">(1)</b>
    @Inject ChildDAO childDAO;
    @Inject SantaClausDAO santaDAO;

    @Transactional
    public void getAGiftFromSanta(Child child, String giftDescription) throws Exception {
        // some transaction work
        Gift gift = childDAO.addToGiftList(child, giftDescription);
        if (gift == null) {
            tm.setRollbackOnly(); <b class="conum">(2)</b>
        }
        else {
            santaDAO.addToSantaTodoList(gift);
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Inject the <code>TransactionManager</code> to be able to activate <code>setRollbackOnly</code> semantic.</p>
</li>
<li>
<p>Programmatically decide to set the transaction for rollback.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="api-approach">API approach</h3>
<div class="paragraph">
<p>The less easy way is to inject a <code>UserTransaction</code> and use the various transaction demarcation methods.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@ApplicationScoped
public class SantaClausService {

    @Inject ChildDAO childDAO
    @Inject SantaClausDAO santaDAO
    @Inject UserTransaction transaction

    public void getAGiftFromSanta(Child child, String giftDescription) throws Exception {
        // some transaction work
        try {
            transaction.begin();
            Gift gift = childDAO.addToGiftList(child, giftDescription);
            santaDAO.addToSantaTodoList(gift);
            transaction.commit();
        }
        catch(SomeException e) {
            // do something on Tx failure
            transaction.rollback();
        }
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>You cannot use <code>UserTransaction</code> in a method having a transaction started by a <code>@Transactional</code> call.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="why-always-having-a-transaction-manager">Why always having a transaction manager?</h2>
<div class="sectionbody">
<div class="dlist">
<dl>
<dt class="hdlist1">Does it work everywhere I want to?</dt>
<dd>
<p>Yep, it works in your Quarkus application, in your IDE, in your tests, because all of these are Quarkus applications.
JTA has some bad press for some people.
I don&#8217;t know why.
Let&#8217;s just say that this is not your grand&#8217;pa&#8217;s JTA implementation.
What we have is perfectly embeddable and lean.</p>
</dd>
<dt class="hdlist1">Does it do 2 Phase Commit and slow down my app?</dt>
<dd>
<p>No, this is an old folk tale.
Let&#8217;s assume it essentially comes for free and let you scale to more complex cases involving several datasources as needed.</p>
</dd>
<dt class="hdlist1">I don&#8217;t need transaction when I do read only operations, it&#8217;s faster.</dt>
<dd>
<p>Wrong.<br>
First off, just disable the transaction by marking your transaction boundary with <code>@Transactional(NOT_SUPPORTED)</code> (or <code>NEVER</code> or <code>SUPPORTS</code> depending on the semantic you want).<br>
Second, it&#8217;s again fairy tale that not using transaction is faster.
The answer is, it depends on your DB and how many SQL SELECTs you are making.
No transaction means the DB does have a single operation transaction context anyways.<br>
Third, when you do several SELECTs, it&#8217;s better to wrap them in a single transaction because they will all be consistent with one another.
Say your DB represents your car dashboard, you can see the number of kilometers remaining and the fuel gauge level.
By reading it in one transaction, they will be consistent.
If you read one and the other from two different transactions, then they can be inconsistent.
It can be more dramatic if you read data related to rights and access management for example.</p>
</dd>
<dt class="hdlist1">Why do you prefer JTA vs Hibernate&#8217;s transaction management API</dt>
<dd>
<p>Managing the transactions manually via <code>entityManager.getTransaction().begin()</code> and friends lead to a butt ugly code with tons of try catch finally that people get wrong.
Transactions are also about JMS and other database access, so one API makes more sense.</p>
</dd>
<dt class="hdlist1">It&#8217;s a mess because I don&#8217;t know if my JPA persistence unit is using <code>JTA</code> or <code>Resource-level</code> Transaction</dt>
<dd>
<p>It&#8217;s not a mess in Quarkus :)
Resource-level was introduced to support JPA in a non managed environment.
But Quarkus is both lean and a managed environment so we can safely always assume we are in JTA mode.
The end result is that the difficulties of running Hibernate ORM + CDI + a transaction manager in Java SE mode are solved by Quarkus.</p>
</dd>
</dl>
</div>
</div>
</div>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/" class="styled-logo">Quarkus</a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. All dependencies of this project are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license.<br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a> is hosted on <a href='https://pages.github.com/' target='_blank'>Github Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what youâ€™ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>Navigation</span>
        <ul class="footer-links width-1-12">
          
            <li><a href="/">Home</a></li>
          
            <li><a href="/guides">Guides</a></li>
          
            <li><a href="/get-started">Get Started</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Contribute</span>
        <ul class="footer-links width-1-12">
          
            <li><a href="https://twitter.com/quarkusio">Follow us</a></li>
          
            <li><a href="https://github.com/quarkusio">GitHub</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Get Help</span>
        <ul class="footer-links width-1-12">
          
            <li><a href="https://quarkusio.zulipchat.com">Chatroom</a></li>
          
        </ul>
      </div>
    

    
      <div class="width-6-12 more-links">
        <span>Quarkus is made of community projects</span>
        <ul class="footer-links">
          
            <li><a href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a href="https://microprofile.io" target="_blank">Eclipse Microprofile</a></li>
          
            <li><a href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a href="http://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
        </ul>
      </div>
    
  </div>
</div>
  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a>
    </span>
    <span class="redhat">
      a Red Hat sponsored project   
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/RHLogo_white.svg"></a>
    </span>
  </div>
</div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript">
    if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
        _satellite.pageBottom();
    }
  </script>
</body>

</html>
