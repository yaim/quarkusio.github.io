<!DOCTYPE html>
<html>

<head>
  <script id="adobe_dtm" src="//www.redhat.com/dtm.js" type="text/javascript"></script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/assets/css/main.css" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-NJWS5L');</script>
  <!-- End Google Tag Manager -->


</head>

<body class="guides">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJWS5L"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <div class="content">
    <div class="navigation-wrapper">
  <div class="width-12-12">
    <div class="header navigation">
      <div class="logo-wrapper">
        <a class="styled-logo" href="/">Quarkus</a>
      </div>
      <div class="nav-container">
        <nav>
          <div class="nav-mobile"><a id="nav-toggle" href="#!"><span></span></a></div>
          <ul class="nav-list">
            <li>
              <a href="/get-started/" class="">Get Started</a>
            </li>
            <li>
              <a href="/guides/" class="active">Guides</a>
            </li>
            <li>
              <a href="/extensions/" class="">Extensions</a>
            </li>
            <li>
              <a href="/community/" class="">Community</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>

    <div class="grid-wrapper guides">
  <div class="grid__item width-12-12">
    <h1 class="text-caps">Quarkus - Using SSL With Native Images</h1>
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>We are quickly moving to an SSL-everywhere world so being able to use SSL is crucial.</p>
</div>
<div class="paragraph">
<p>In this guide, we will discuss how you can get your native images to support SSL,
as native images don&#8217;t support it out of the box.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you don&#8217;t plan on using native images, you can pass your way as in JDK mode, SSL is supported without further manipulations.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="prerequisites">Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To complete this guide, you need:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>less than 20 minutes</p>
</li>
<li>
<p>an IDE</p>
</li>
<li>
<p>GraalVM installed with <code>JAVA_HOME</code> and <code>GRAALVM_HOME</code> configured appropriately</p>
</li>
<li>
<p>Apache Maven 3.5.3+</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This guide is based on the REST client guide so you should get this Maven project first.</p>
</div>
<div class="paragraph">
<p>Clone the Git repository: <code>git clone <a href="https://github.com/jbossas/protean-quickstarts.git" class="bare">https://github.com/jbossas/protean-quickstarts.git</a></code>, or download an <a href="https://github.com/jbossas/protean-quickstarts/archive/master.zip">archive</a>.</p>
</div>
<div class="paragraph">
<p>The project is located in the <code>rest-client</code> <a href="https://github.com/jbossas/protean-quickstarts/tree/master/rest-client">directory</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="looks-like-it-works-out-of-the-box">Looks like it works out of the box?!?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you open the application&#8217;s configuration file (<code>src/main/resources/META-INF/microprofile-config.properties</code>), you can see the following line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>org.acme.restclient.CountriesService/mp-rest/url=https://restcountries.eu/rest</code></pre>
</div>
</div>
<div class="paragraph">
<p>which configures our REST client to connect to an SSL REST service.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s build the application as a native image and run the tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>mvn clean install -Pnative</code></pre>
</div>
</div>
<div class="paragraph">
<p>And we obtain the following result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------</code></pre>
</div>
</div>
<div class="paragraph">
<p>So, yes, it appears it works out of the box and this guide is pretty useless.</p>
</div>
<div class="paragraph">
<p>It&#8217;s not. The magic happens when building the native image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[INFO] [io.quarkus.creator.phase.nativeimage.NativeImagePhase] /opt/graalvm/bin/native-image -J-Djava.util.logging.manager=org.jboss.logmanager.LogManager -J-Dcom.sun.xml.internal.bind.v2.bytecode.ClassTailor.noOptimize=true -H:InitialCollectionPolicy=com.oracle.svm.core.genscavenge.CollectionPolicy$BySpaceAndTime -jar rest-client-1.0-SNAPSHOT-runner.jar -J-Djava.util.concurrent.ForkJoinPool.common.parallelism=1 -H:+PrintAnalysisCallTree -H:EnableURLProtocols=http,https --enable-all-security-services -H:-SpawnIsolates -H:+JNI --no-server -H:-UseServiceLoaderFeature -H:+StackTrace</code></pre>
</div>
</div>
<div class="paragraph">
<p>The important elements are these 3 options:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>-H:EnableURLProtocols=http,https --enable-all-security-services -H:+JNI</code></pre>
</div>
</div>
<div class="paragraph">
<p>They enable the native SSL support for your native image.</p>
</div>
<div class="paragraph">
<p>As SSL is ipso facto the standard nowadays, we decided to enable its support automatically for some of our extensions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the SmallRye REST client extension,</p>
</li>
<li>
<p>the Agroal connection pooling extension,</p>
</li>
<li>
<p>the Jaeger extension.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As long as you have one of those extensions in your project, the SSL support will be enabled by default.</p>
</div>
<div class="paragraph">
<p>Now, let&#8217;s just check the size of our native image as it will be useful later:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ ls -lh target/rest-client-1.0-SNAPSHOT-runner
-rwxrwxr-x. 1 gsmet gsmet 34M Feb 22 15:27 target/rest-client-1.0-SNAPSHOT-runner</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lets-disable-ssl-and-see-how-it-goes">Let&#8217;s disable SSL and see how it goes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus has an option to disable the SSL support entirely.
Why? Because it comes at a certain cost.
So if you are sure you don&#8217;t need it, you can disable it entirely.</p>
</div>
<div class="paragraph">
<p>First, let&#8217;s disable it without changing the REST service URL and see how it goes.</p>
</div>
<div class="paragraph">
<p>Open <code>src/main/resources/META-INF/microprofile-config.properties</code> and add the following line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>quarkus.ssl.native=false</code></pre>
</div>
</div>
<div class="paragraph">
<p>And let&#8217;s try to build again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>mvn clean install -Pnative</code></pre>
</div>
</div>
<div class="paragraph">
<p>The native image tests will fail with the following error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Exception handling request to /country/name/greece: com.oracle.svm.core.jdk.UnsupportedFeatureError: Accessing an URL protocol that was not enabled. The URL protocol https is supported but not enabled by default. It must be enabled by adding the --enable-url-protocols=https option to the native-image command.</code></pre>
</div>
</div>
<div class="paragraph">
<p>This error is the one you obtain when trying to use SSL while it was not explicitly enabled in your native image.</p>
</div>
<div class="paragraph">
<p>Now, let&#8217;s change the REST service URL to <strong>not</strong> use SSL in <code>src/main/resources/META-INF/microprofile-config.properties</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>org.acme.restclient.CountriesService/mp-rest/url=http://restcountries.eu/rest</code></pre>
</div>
</div>
<div class="paragraph">
<p>And build again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>mvn clean install -Pnative</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you check carefully the native image build options, you can see that the SSL related options are gone:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[INFO] [io.quarkus.creator.phase.nativeimage.NativeImagePhase] /opt/graalvm/bin/native-image -J-Djava.util.logging.manager=org.jboss.logmanager.LogManager -J-Dcom.sun.xml.internal.bind.v2.bytecode.ClassTailor.noOptimize=true -H:InitialCollectionPolicy=com.oracle.svm.core.genscavenge.CollectionPolicy$BySpaceAndTime -jar rest-client-1.0-SNAPSHOT-runner.jar -J-Djava.util.concurrent.ForkJoinPool.common.parallelism=1 -H:+PrintAnalysisCallTree -H:EnableURLProtocols=http -H:-SpawnIsolates -H:-JNI --no-server -H:-UseServiceLoaderFeature -H:+StackTrace</code></pre>
</div>
</div>
<div class="paragraph">
<p>And we end up with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------</code></pre>
</div>
</div>
<div class="paragraph">
<p>You remember we checked the size of the native image with SSL enabled?
Let&#8217;s check again with SSL support entirely disabled:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ ls -lh target/rest-client-1.0-SNAPSHOT-runner
-rwxrwxr-x. 1 gsmet gsmet 25M Feb 22 15:19 target/rest-client-1.0-SNAPSHOT-runner</code></pre>
</div>
</div>
<div class="paragraph">
<p>Yes, it is now <strong>25 MB</strong> whereas it used to be <strong>34 MB</strong>. SSL comes with a 9 MB overhead in native image size.</p>
</div>
<div class="paragraph">
<p>And there&#8217;s more to it.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lets-start-again-with-a-clean-slate">Let&#8217;s start again with a clean slate</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s revert the changes we made to the configuration file and go back to SSL with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>git checkout -- src/main/resources/META-INF/microprofile-config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<p>And let&#8217;s build the native image again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>mvn clean install -Pnative</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-sunec-library-and-friends">The SunEC library and friends</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You haven&#8217;t noticed anything but, while building the image,
Quarkus has automatically set <code>java.library.path</code> to point to the GraalVM library folder (the one containing the SunEC library).</p>
</div>
<div class="paragraph">
<p>It has also set <code>javax.net.ssl.trustStore</code> to point to the <code>cacerts</code> file bundled in the GraalVM distribution.
This file contains the root certificates.</p>
</div>
<div class="paragraph">
<p>This is useful when running tests but, obviously, it is not portable as these paths are hardcoded.</p>
</div>
<div class="paragraph">
<p>You can check that pretty easily:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>move your GraalVM directory to another place (let&#8217;s call it <code>&lt;new-graalvm-home&gt;</code>)</p>
</li>
<li>
<p>run the native image <code>./target/rest-client-1.0-SNAPSHOT-runner</code></p>
</li>
<li>
<p>in a browser, go to <code><a href="http://localhost:8080/country/name/greece" class="bare">http://localhost:8080/country/name/greece</a></code></p>
</li>
<li>
<p>you will have an Internal Server Error</p>
</li>
<li>
<p>in your terminal, you should have a warning <code>WARNING: The sunec native library, required by the SunEC provider, could not be loaded.</code>
and an exception too: <code>java.security.InvalidAlgorithmParameterException: the trustAnchors parameter must be non-empty</code></p>
</li>
<li>
<p>hit <code>Ctrl+C</code> to stop the application</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To make it work, you need to manually set <code>java.library.path</code> and <code>javax.net.ssl.trustStore</code> to point to the new GraalVM home:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>./target/rest-client-1.0-SNAPSHOT-runner -Djava.library.path=&lt;new-graalvm-home&gt;/jre/lib/amd64 -Djavax.net.ssl.trustStore=&lt;new-graalvm-home&gt;/jre/lib/security/cacerts</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, the application should work as expected:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>in a browser, go to <code><a href="http://localhost:8080/country/name/greece" class="bare">http://localhost:8080/country/name/greece</a></code></p>
</li>
<li>
<p>you should see a JSON output with some information about Greece</p>
</li>
<li>
<p>hit <code>Ctrl+C</code> to stop the application</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When working with containers, the idea is to bundle both the SunEC library and the certificates in the container and to point your binary to them using the system properties mentioned above.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>The root certificates file of GraalVM might not be totally up to date.
If you have issues with some certificates, your best bet is to include the <code>cacerts</code> file of a regular JDK instead.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>Don&#8217;t forget to move your GraalVM directory back to where it was.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We make building native images easy and, even if the SSL support in GraalVM is still requiring some serious thinking,
it should be mostly transparent when using Quarkus.</p>
</div>
<div class="paragraph">
<p>Hopefully, the situation will improve in the future:
the native image size overhead will be reduced and the SunCE library might not be needed anymore.</p>
</div>
<div class="paragraph">
<p>We track GraalVM progress on a regular basis so we will promptly integrate in Quarkus any improvement with respect to SSL support.</p>
</div>
</div>
</div>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/" class="styled-logo">Quarkus</a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. All dependencies of this project are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license.<br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a> is hosted on <a href='https://pages.github.com/' target='_blank'>Github Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what youâ€™ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>Navigation</span>
        <ul class="footer-links width-1-12">
          
            <li><a href="/">Home</a></li>
          
            <li><a href="/guides">Guides</a></li>
          
            <li><a href="/get-started">Get Started</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Contribute</span>
        <ul class="footer-links width-1-12">
          
            <li><a href="https://twitter.com/quarkusio">Follow us</a></li>
          
            <li><a href="https://github.com/quarkusio">GitHub</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Get Help</span>
        <ul class="footer-links width-1-12">
          
            <li><a href="https://quarkusio.zulipchat.com">Chatroom</a></li>
          
        </ul>
      </div>
    

    
      <div class="width-6-12 more-links">
        <span>Quarkus is made of community projects</span>
        <ul class="footer-links">
          
            <li><a href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a href="https://microprofile.io" target="_blank">Eclipse Microprofile</a></li>
          
            <li><a href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a href="http://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
        </ul>
      </div>
    
  </div>
</div>
  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a>
    </span>
    <span class="redhat">
      a Red Hat sponsored project   
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/RHLogo_white.svg"></a>
    </span>
  </div>
</div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript">
    if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
        _satellite.pageBottom();
    }
  </script>
</body>

</html>
